# 头像与用户人格执行计划（独立）

## 1. 目标
1. 用户与每个人格都可单独设置头像。
2. 新增“用户人格”，且永远不可删除。
3. 对话窗口不再显示名字，改为头像显示。
4. 头像支持裁剪后缓存，提升加载与存储效率。

## 2. 范围
1. 配置窗口人格页新增头像设置能力（上传、裁剪、保存、清除）。
2. 对话窗口消息头改为头像（组件库 `avatar` 组件）。
3. 数据结构与持久化扩展：用户头像 + 人格头像。
4. 头像文件缓存与版本刷新策略。

## 3. 设计约束
1. 用户人格固定存在，不可删除，UI 显示“用户人格”标识。
2. 头像统一输出 `128x128`、`webp`、质量约 `80`。
3. 头像目录统一存储到应用数据目录 `avatars/`。
4. 无头像时使用组件库默认占位头像。
5. 无头像时显示首字回退（人格名/用户称谓的第一个字，空值显示 `?`）。

## 4. 数据模型变更
1. `AgentProfile` 增加：
   `avatarPath?: string`
   `avatarUpdatedAt?: string`
   `isBuiltInUser?: boolean`
2. 聊天设置增加：
   `userAvatarPath?: string`
   `userAvatarUpdatedAt?: string`

## 5. 后端接口（建议）
1. `save_avatar(input) -> { path, updatedAt }`
2. `clear_avatar(input) -> { ok }`
3. （可选）`resolve_avatar_url(input) -> { url }`

## 6. 前端交互
1. 人格页增加头像卡片：
   上传按钮、裁剪弹窗、保存按钮、清除按钮。
2. 用户人格卡片删除按钮禁用，并展示提示文案。
3. 对话页：
   用户消息右侧头像，助手消息左侧头像。
4. 头像 URL 使用 `?v=avatarUpdatedAt` 防止缓存不刷新。
5. 首字头像背景色按 `id` 哈希稳定映射，确保识别一致。
6. 裁剪前先执行大图缩放（最大边 `1024`）避免卡顿与内存峰值。
7. 头像组件补充 `title/aria-label`，提高可访问性。

## 7. 实施步骤
1. 第一步：数据结构与后端命令落地。
2. 第二步：人格页接入头像上传裁剪与保存。
3. 第三步：对话窗口改为头像显示。
4. 第四步：补充测试与边界修复。

## 8. 验收标准
1. 用户人格始终存在且不可删除。
2. 用户头像与人格头像可独立设置并重启保留。
3. 对话窗口仅显示头像，不显示名字文本。
4. 头像更新后立刻可见，无需重启。
5. 清除头像后可正确回退占位头像。
6. 无头像时首字显示正确，背景色跨会话保持一致。
7. 上传超大图片时不会造成明显卡顿。
