# 归档与记忆联动实施计划

## 目标
- 建立“按上下文压力触发”的归档机制，避免上下文爆满导致对话质量下降。
- 归档时同步生成摘要与高价值记忆，持续提升后续对话质量。
- 归档过程可观测、可冻结、可恢复，且不污染前端聊天主视图。

## 规则定稿

### 1. 计时规则
- 仅在“用户发言后”开始计时。
- 若用户一直不发言，不触发 30 分钟归档判断。
- 延迟检查固定为 `30 分钟`（无短延迟防抖）。

### 2. 普通归档触发条件
- 距离最近一次用户发言 `>= 30 分钟`
- 且上下文占用率 `>= 30%`

### 3. 强制归档触发条件
- 仅在“用户发言后进行检查”时判断是否 `>= 82%`，命中则立即强制归档。
- 流式回复过程中不做 82% 检查。
- 强制归档期间冻结聊天窗口（输入、发送、粘贴、录音禁用）。

### 4. Token 本地估算
- 英文字符：`1 char ≈ 0.3 token`
- 中文字符：`1 char ≈ 0.6 token`
- 优先使用模型返回 usage；无 usage 时使用本地估算。

## 实施阶段

## 阶段 A：数据结构与配置
- 新增归档策略配置：
- `archive_idle_minutes = 30`
- `archive_min_usage_ratio = 0.30`
- `archive_force_usage_ratio = 0.82`
- API 配置新增：
- `context_window_tokens`（上下文窗口）
- 默认值 `128000`，最大值 `200000`
- UI 提供滑条编辑
- 会话状态新增：
- `last_user_message_at`
- `context_usage_ratio`
- `archive_in_progress`
- 归档对象新增：
- `summary`
- `memories`（最多 7 条）

## 阶段 B：上下文占用计算
- 封装统一 token 估算函数。
- 统一输出 `context_usage_ratio`，供 UI 与触发器共享。
- 增加日志：usage 来源（provider / local estimate）。

## 阶段 C：归档触发器重构
- 只在以下时点执行归档检查：
- 用户发言后（固定 30 分钟检查）
- 助手回复完成后（即时检查）
- 判断分支：
- `>=82%`：强制归档
- `>=30min && >=30%`：普通归档
- 其他：不归档

## 阶段 D：归档执行与冻结态
- 归档开始时设置 `archive_in_progress = true`。
- 前端进入冻结态并展示“正在归档优化上下文...”。
- 成功后解冻。
- 失败时回退策略：
- 以最近三轮对话作为“纯净新开头”重建上下文。
- 若最近三轮仍超上下文阈值，则直接开启新对话（空上下文开局）。
- 回退后解冻并提示已自动重建对话上下文。

## 阶段 E：摘要与记忆一体生成
- 归档任务输出：
- 必选：归档摘要
- 可选：高价值记忆（<=7，非必要不生成）
- 摘要阶段工具调用上限：
- 仅允许 `memory-save` 工具参与摘要阶段
- `fetch`、`bing-search` 等其他工具在摘要阶段全部禁用
- 若当前对话模型不支持工具，则摘要阶段不启用任何工具（不会绕过能力限制）
- 最多允许调用 `3` 次工具
- 超过上限后，强制注入提示词：`工具调用次数已达上限，必须立刻生成归档摘要，不得继续调用工具。`
- 记忆结构：
- `content`
- `keywords[]`
- 写入记忆库时做去重与合并。

## 阶段 F：发送前隐藏注入
- 每次发消息前，注入隐藏上下文（不显示在 UI）：
- 用户：`上次我们聊到哪里？`
- 助手：`<归档摘要>`
- 注入仅作用于模型请求，不写入可见消息列表。

## 阶段 G：摘要也启用记忆召回
- 摘要请求同样执行“记忆命中召回”。
- 命中的记忆以额外文本块注入摘要流程。

## 阶段 H：测试与验收
- 单测：
- token 估算与占用率计算
- 归档阈值判定分支
- 集成测试：
- 普通归档流程
- 强制归档与冻结/解冻
- 摘要+记忆落库
- 手测清单：
- 82% 强制归档是否立即生效
- 30 分钟 + 30% 归档是否准确触发
- 冻结期间交互是否完全禁用

## 完成标准（DoD）
- 归档触发符合阈值规则，无误触或漏触。
- 归档期间 UI 冻结表现稳定，失败可恢复。
- 每次归档均可得到摘要；记忆生成遵守“非必要不生成”。
- 摘要注入与记忆召回对后续对话稳定生效。
