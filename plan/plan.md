# Easy Call AI 开发计划（可执行版）

## 0. 计划目标

在现有 `Tauri + Vue + Rust` 架构上，分阶段实现：

1. 三种 AI 配置（对话 / 音转文 / 图转文）与能力筛选
2. 多模态转换管线（图片、音频）
3. 缓存与归档一致性
4. 录音交互与错误恢复
5. 可验证、低成本的测试体系

---

## 1. 范围与非范围

### 1.1 本期范围
- API 配置能力字段：`enable_text` / `enable_image` / `enable_audio` / `enable_tools`
- 三种 AI 绑定：`chat_api_id` / `stt_api_id` / `vision_api_id`
- 图片与音频的转换决策逻辑
- 图片缓存（哈希去重 + 压缩存储）
- 配置界面与对话界面联动
- 单元测试 + Mock 集成测试 + 冒烟脚本

### 1.2 本期非范围
- Tool call / MCP 的完整执行（仅保留兼容数据结构）
- 语音合成（TTS）
- 云端同步

---

## 2. 数据与存储规范

统一使用应用配置目录（ProjectDirs）：

```text
~/.config/easycall/easy-call-ai/
├── config.toml
├── conversations.json
├── agents.yml
├── archives.json
└── cache/
    └── images/
```

### 2.1 约定
- 不兼容旧配置（直接采用新结构）
- 图片仅保存压缩后的缓存版本，不保留原始大图
- 音频识别完成后不持久化原始音频，仅保留必要文本与元数据

### 2.2 消息结构（统一转换层）
- 保留 `text/image/audio/tool_call/mcp` 的扩展位
- 发送前由 Provider Adapter 转换为各供应商请求体
- 先实现：`openai` / `gemini` / `deepseek_kimi`

---

## 3. 里程碑计划

## M0 基线冻结（0.5 天）

### 任务
1. 冻结数据结构 v2（配置、会话、归档、缓存索引）
2. 新增文档：`docs/data-schema-v2.md`、`docs/migration.md`
3. 启动时校验必填字段并给出友好提示

### 验收标准
1. 新安装可直接启动
2. 缺失关键字段时提示明确，不崩溃

---

## M1 三种 AI 配置与筛选（1 天）

### 任务
1. 配置中心新增三类 AI 绑定字段
2. 配置 UI 三个下拉筛选：
   - 对话 AI：`enable_text = true`
   - 音转文 AI：`enable_audio = true`
   - 图转文 AI：`enable_image = true`
3. 当前选中项显示能力徽标（text/image/audio/tools）

### 验收标准
1. 三类绑定可独立保存
2. 重启后配置一致
3. 无可选项时正确显示空状态与禁用

---

## M2 多模态转换管线（2 天）

### 任务
1. 图片流程：
   - 计算哈希 -> 查缓存
   - 命中：直接使用缓存文本
   - 未命中：若对话 AI 支持图片则直发；否则走图转文 AI
2. 音频流程：
   - 若对话 AI 支持音频则直发
   - 否则走音转文 AI，结果回填输入框由用户确认发送
3. 转换层：
   - 统一内部消息 -> Provider 请求体
   - Provider 错误码标准化

### 验收标准
1. 三供应商（openai/gemini/deepseek_kimi）各通过 1 条图片链路
2. 音频在“直发”和“转写回填”两路径都可用
3. 转换失败可重试，错误提示可读

---

## M3 缓存系统（1 天）

### 任务
1. 图片缓存目录与索引管理（hash、mime、size、timestamps）
2. 压缩策略（质量与尺寸上限可配置）
3. 配置页缓存统计与清理
4. 图转文 AI 切换时缓存可配置是否失效

### 验收标准
1. 同图二次发送命中缓存
2. 清理缓存后磁盘占用下降
3. 缓存损坏时可自动恢复/跳过

---

## M4 录音功能（2 天）

### 任务
1. 按住录音，松开发送/转写
2. 限制：
   - 最短时长（默认 1s）
   - 最长时长（默认 60s）
   - 可选静音自动停止（默认关）
3. 录音状态提示、取消、超时处理

### 验收标准
1. Windows 连续录音 10 次不崩
2. 小于最短时长自动丢弃并提示
3. 超时/失败可恢复，不污染输入框

---

## M5 UI 联动与体验收敛（1.5 天）

### 任务
1. 配置页与对话页状态实时同步（去掉多余干扰提示）
2. 转换中状态、失败重试、禁用态提示统一
3. 对话窗口保持极简：仅当前回合主视图 + 历史入口

### 验收标准
1. 不出现空气泡/空消息
2. 不支持能力时的文案与行为一致
3. 关键链路（粘贴图/录音/发送）可在 1~2 步完成

---

## M6 测试与发布门槛（1.5 天）

### 任务
1. Rust 单测：
   - Provider 请求体构建
   - 缓存命中/失效
   - 转换错误映射
2. Rust 集成测试：
   - Mock HTTP 服务覆盖三供应商主流程
3. 前端测试：
   - 关键状态机（idle/sending/converting/error）
4. 冒烟脚本：
   - 使用 debug API 运行全流程，避免高成本真实调用

### 验收标准
1. 核心测试通过
2. 冒烟脚本 1 次通过率 >= 95%
3. 发布前人工仅需 3 条回归场景

---

## 4. 实施顺序与依赖

1. `M0 -> M1`：先定结构与配置，避免后续反复迁移
2. `M2` 依赖 `M1`：转换管线必须先拿到三类 AI 绑定
3. `M3` 可与 `M4` 并行（后端缓存 / 音频模块）
4. `M5` 在 `M2~M4` 完成后统一收敛交互
5. `M6` 贯穿补充，但最终统一收口

---

## 5. 风险与对策

1. 录音跨平台差异
   - 对策：先锁 Windows，其他平台降级提示
2. Provider 差异导致请求体不兼容
   - 对策：统一 Adapter + 请求快照测试
3. 缓存一致性（切换模型后语义变化）
   - 对策：缓存写入附带 `vision_api_id` 与版本戳
4. 真实 API 成本过高
   - 对策：默认 debug provider + mock 测试

---

## 6. 交付清单

1. 代码改动（Rust + Vue）
2. 数据结构文档与运行手册
3. 测试脚本与 CI 入口
4. 发布检查清单（配置、缓存、录音、三供应商）

---

## 7. 当前阶段建议

建议从 `M0 + M1` 一次性完成并提交，再进入 `M2`。  
这样可以先稳定配置中心，再做多模态主链路，返工最少。
